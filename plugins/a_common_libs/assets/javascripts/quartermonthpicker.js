!function(b){var a=function(e,d,c){var g=typeof d=="object";var f;this.startDate="";this.endDate="";this.year=moment().year();this.format="DD.MM.YYYY";this.separator=" \u2014 ";this.selectCount=2;this.hideDelay=200;this.closeAfter2Click=false;this.yearsBeforeAfter=1;if(typeof RMPlus.Utils.locale!="undefined"){this.locale=RMPlus.Utils.locale}else{this.locale={clearButton:"Очистить",closeButton:"Закрыть",monthNames:["Янв","Фев","Мар","Апр","Май","Июн","Июл","Авг","Сен","Окт","Ноя","Дек"],quarterNames:["I кв.","II кв.","III кв.","IV кв."]}}this.cb=function(){};this.parentEl=document.body;this.container=b('<div class="qmpicker"></div>').appendTo(this.parentEl);this.element=b(e);if(this.element.is("input")){this.element.on({click:b.proxy(this.show,this)})}else{this.element.on("click",b.proxy(this.show,this))}f=this.locale;if(g){if(typeof d.format=="string"){this.format=d.format}if(typeof d.separator=="string"){this.separator=d.separator}if(typeof d.startDate=="string"&&d.startDate!=""){this.startDate=moment(d.startDate)}if(typeof d.endDate=="string"&&d.endDate!=""){this.endDate=moment(d.endDate)}if(typeof d.yearsBeforeAfter=="integer"){this.yearsBeforeAfter=d.yearsBeforeAfter}if(typeof d.locale=="object"){b.each(f,function(i,h){f[i]=d.locale[i]||h})}}if(typeof c=="function"){this.cb=c}this.container.on("mousedown",b.proxy(this.mousedown,this));this.container.on("click",".prev-year",b.proxy(this.clickPrevYear,this)).on("click",".next-year",b.proxy(this.clickNextYear,this)).on("click",".qmp-daterange",b.proxy(this.clickDateRange,this)).on("click",".qmp-clear",b.proxy(this.clearRange,this)).on("click",".qmp-close",b.proxy(this.hide,this));this.element.prop("readonly","readonly");this.updateView()};a.prototype={constructor:a,mousedown:function(c){c.stopPropagation()},updateView:function(){this.container.html(this.renderCalendar(this.year));this.updateInputText();this.updateSelection()},updateSelection:function(){var d=moment(this.startDate).format("YYYY-MM-DD");var c=moment(this.endDate).format("YYYY-MM-DD");b(this.container).find(".qmp-daterange").each(function(e){if(b(this).attr("data-start-date")>=d&&b(this).attr("data-end-date")<=c){b(this).addClass("qmp-selected");if(b(this).hasClass("qmp-month")&&(b(this).attr("data-start-date")==d||b(this).attr("data-end-date")==c)){b(this).addClass("qmp-range-edge")}else{b(this).removeClass("qmp-range-edge")}}else{b(this).removeClass("qmp-selected qmp-range-edge")}})},clearSelection:function(){b(this.container).find(".qmp-daterange").removeClass("qmp-selected qmp-range-edge")},notify:function(){this.cb(this.startDate,this.endDate)},move:function(){var c={top:2,left:0};this.container.css({top:this.element.offset().top+this.element.outerHeight()+c.top,left:this.element.offset().left,right:"auto"});if(this.container.offset().left+this.container.outerWidth()>b(window).width()){this.container.css({left:"auto",right:0})}},show:function(c){console.log("click!!!!");this.container.show();this.move();if(c){c.stopPropagation();c.preventDefault()}b(document).on("mousedown",b.proxy(this.hide,this));this.element.trigger("shown",{target:c.target,picker:this})},hide:function(c){this.selectCount=2;this.container.hide();b(document).off("mousedown",this.hide);this.element.trigger("hidden",{picker:this});this.notify()},updateInputText:function(){if(this.element.is("input")&&this.startDate!=""&&this.endDate!=""){this.element.val(this.startDate.format(this.format)+this.separator+this.endDate.format(this.format))}else{this.clearRange}},clearRange:function(){this.startDate="";this.endDate="";this.clearSelection();if(this.element.is("input")){this.element.val("")}},clickDateRange:function(g){var d=b(g.target);if(d.is("span")){d=d.parent()}if(!d.is("div.qmp-daterange")){return false}var c=moment(d.attr("data-start-date"));var f=moment(d.attr("data-end-date"));if(this.selectCount>1||(c>=this.startDate&&f<this.endDate)||(c>this.startDate&&f<=this.endDate)){this.selectCount=1;this.startDate=c;this.endDate=f}else{this.selectCount++;if(c>this.endDate){this.endDate=f}else{if(f<this.startDate){this.startDate=c}else{this.startDate=c;this.endDate=f}}}this.updateInputText();this.updateSelection();if(this.selectCount>1&&this.closeAfter2Click){setTimeout(b.proxy(this.hide,this),this.hideDelay)}},clickPrevYear:function(c){this.year--;this.updateView();if(c){c.stopPropagation()}},clickNextYear:function(c){this.year++;this.updateView();if(c){c.stopPropagation()}},renderQuarter:function(f,d){var c=moment([f,0,1]).add("month",(d-1)*3);var e='<table class="qmp-quarter"><tr><td rowspan="3" class="qmp-quarter-cell"><div class="qmp-quarter-label qmp-daterange" data-start-date="'+c.format("YYYY-MM-DD")+'" data-end-date="'+moment(c).add("month",2).endOf("month").format("YYYY-MM-DD")+'"><span>'+this.locale.quarterNames[c.quarter()-1]+'</span></div></td><td class="qmp-first-mon"><div class="qmp-month qmp-daterange" data-start-date="'+c.format("YYYY-MM-DD")+'" data-end-date="'+moment(c).endOf("month").format("YYYY-MM-DD")+'"><span>'+this.locale.monthNames[c.month()]+"</span></div></td></tr>";c.add(1,"month");e+='<tr><td class="qmp-mid-mon"><div class="qmp-month qmp-daterange" data-start-date="'+c.format("YYYY-MM-DD")+'" data-end-date="'+moment(c).endOf("month").format("YYYY-MM-DD")+'"><span>'+this.locale.monthNames[c.month()]+"</span></div></td></tr>";c.add(1,"month");e+='<tr><td class="qmp-last-mon"><div class="qmp-month qmp-daterange" data-start-date="'+c.format("YYYY-MM-DD")+'" data-end-date="'+moment(c).endOf("month").format("YYYY-MM-DD")+'"><span>'+this.locale.monthNames[c.month()]+"</span></div></td></tr>";e+="</table>";return e},renderYear:function(f,g){var e="";if(g=="last"){e='<div class="next-year"><span>&rarr;</span></div>'}else{if(g=="first"){e='<div class="prev-year"><span>&larr;</span></div>'}}var d='<div class="qmp-year"><div class="qmp-year-head">'+e+'<div class="qmp-year-label qmp-daterange" data-start-date="'+moment([f,0,1]).format("YYYY-MM-DD")+'" data-end-date="'+moment([f,11,1]).endOf("month").format("YYYY-MM-DD")+'"><span>'+f.toString()+"</span></div></div>";for(var c=1;c<=4;c++){d+=this.renderQuarter(f,c)}d+="</div>";return d},renderCalendar:function(e){var d='<div class="qmp-calendar">';for(var c=-this.yearsBeforeAfter;c<=this.yearsBeforeAfter;c++){var f=(c==this.yearsBeforeAfter)?"last":"";f=(c==-this.yearsBeforeAfter)?"first":f;d+=this.renderYear(e+c,f)}d+='<div class="qmp-bottom"><input class="R qmp-close" type=button value="'+this.locale.closeButton+'" /><input class="R qmp-clear" type=button value="'+this.locale.clearButton+'" /></div>';d+="</div>";return d}};b.fn.qmpicker=function(d,c){this.each(function(){var e=b(this);if(!e.data("qmpicker")){e.data("qmpicker",new a(e,d,c))}});return this}}(window.jQuery);