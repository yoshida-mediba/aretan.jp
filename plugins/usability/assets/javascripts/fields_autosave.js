RMPlus.Usability=(function(a){var a=a||{};a.available_autosave=function(){if(!a.settings.use_autosave_fields){return false}if(!a.settings.autosave_fields_limitation||a.settings.autosave_fields_limitation<=0){return false}return true};a.available_local_storage=function(){if(!localStorage){return false}try{return"localStorage" in window&&window.localStorage!==null}catch(b){return false}};a.available_field_for_autosave=function(b){return b&&((b.tagName=="INPUT"&&b.type=="text")||b.tagName=="TEXTAREA")};a.get_field_selector=function(c){if(c.id){return"#"+c.id}var b=c.tagName.toLowerCase();if(c.className){b+="."+c.className.replace(" ",".")}if(c.tagName=="INPUT"){b=b+'[type="'+c.type+'"]'}if(c.name){b=b+'[name="'+c.name+'"]'}return b};a.save_fields_data=function(){if(!a.available_autosave()){return}if(!a.available_local_storage()){return}var h=localStorage[window.location.pathname];if(h){h=JSON.parse(h)}else{h={}}var i=[];var g=a.settings.autosave_fields||".us-autosave";g=$(g.replace(/\,/g,":visible,")+":visible").get();for(var b=0;b<g.length;b++){var j=g[b];var e=j.value.trim();var k=j.getAttribute("data-guid");if(!k){k=a.create_guid();j.setAttribute("data-guid",k)}if(!a.available_field_for_autosave(j)){continue}var f=a.get_field_selector(j);if(!h[f]){h[f]={}}if(e){if(h[f][k]!=e){i.push(j)}h[f][k]=e}else{if(h[f][k]){i.push(j)}delete h[f][k]}var c=Object.keys(h[f]);if(c.length>a.settings.autosave_fields_limitation){for(var d=0;d<c.length-a.settings.autosave_fields_limitation;d++){delete h[f][c[d]]}}}localStorage[window.location.pathname]=JSON.stringify(h);if(i.length>0){a.show_saved_label(i)}return localStorage[window.location.pathname]};a.delete_field_data=function(d,c){if(!a.available_local_storage()){return}var e=localStorage[window.location.pathname];if(!e){return}e=JSON.parse(e);var b=a.get_field_selector(d);if(!e[b]){return}if(!c){e[b]=[]}else{delete e[b][c]}return localStorage[window.location.pathname]=JSON.stringify(e)};a.create_guid=function(){var c=new Date().getTime();var b="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var d=(c+Math.random()*16)%16|0;c=Math.floor(c/16);return(e=="x"?d:(d&3|8)).toString(16)});return b};a.show_saved_label=function(b){if(!b||b.length==0){return}for(var d=0;d<b.length;d++){var c=$(b[d]).data("link");if(!c){if(b[d]===document.activeElement){a.show_history_link(b[d]);c=$(b[d]).data("link")}}if(!c){continue}if(c.hasClass("us-saved")){continue}var e=$('<span style="display:none;">'+a.msg_autosaved+"</span>");c.append(e);c.addClass("us-saved");e.fadeIn("fast",function(){$(this).delay(1000).fadeOut("fast",function(){var g=$(this);var f=g.parent().removeClass("us-saved");g.remove();f=f.data("elem");if(!f||!f[0]){return}if(!a.field_history(f[0])){a.hide_history_link(f[0])}})})}};a.field_history=function(c){if(!a.available_autosave()){return false}if(!a.available_local_storage()){return false}if(!a.available_field_for_autosave(c)){return false}var d=localStorage[window.location.pathname];if(!d){return false}d=JSON.parse(d);var b=a.get_field_selector(c);if(!d[b]){return false}if(Object.keys(d[b]).length==0){return false}return d[b]};a.show_history_link=function(d){var c=$(d);if(c.data("link")){return}if(!a.field_history(d)){return}var b=$('<a id="'+a.create_guid()+'" href="#" class="us-history-autosaves no_line link_to_modal click_out static_content_only over_parent_window" style="display:none;"></a>');c.after(b);b.modal_window();b.click(function(){var k=$(this).data("modal_window").$window;var g=b.data("elem");if(!g){return false}var f=a.field_history(g[0]);if(!f){return false}var e='<table class="list">';var i=Object.keys(f);for(var j=0;j<i.length;j++){e+='<tr data-id="'+i[j]+'">';e+="<td>";e+=(f[i[j]].length>50?(f[i[j]].substring(0,50)+"..."):f[i[j]]);e+="</td>";e+='<td width="1px">';e+='<a href="#" class="icon icon-del no_line us-autosave-delete"></a>';e+="</td>";e+="</tr>"}e+="</table>";k.html(e);k.addClass("us-autosaved-list")});b.fadeIn("fast");c.data("link",b);b.data("elem",c)};a.hide_history_link=function(c){if(!c){return}var b=$(c);var d=b.data("link");if(a.field_history(c)){if(c===document.activeElement||(d&&d[0]===document.activeElement)){return}}d&&d.fadeOut("fast",function(){$(this).modal_window("destroy").remove()});b.removeData("link")};return a})(RMPlus.Usability||{});$(document).ready(function(){if(RMPlus.Usability.available_autosave()){setInterval(RMPlus.Usability.save_fields_data,30000);$(document.body).on("focus",RMPlus.Usability.settings.autosave_fields||".us-autosave",function(){RMPlus.Usability.show_history_link(this)});$(document.body).on("blur",RMPlus.Usability.settings.autosave_fields||".us-autosave",function(){setTimeout($.proxy(function(){RMPlus.Usability.hide_history_link(this)},this),100)});$(document.body).on("modal_window_hidden","a.us-history-autosaves",function(){var a=$(this).data("elem");a&&RMPlus.Usability.hide_history_link(a[0])});$(document.body).on("click","div.modal_window.us-autosaved-list table tr",function(){var b=$(this);var d=b.parents("div.modal_window:first");if(d.length==0){return}var a=d.data("modal_window").$element.data("elem");if(!a){return}var c=RMPlus.Usability.field_history(a[0]);if(!c){return}c=c[b.attr("data-id")];if(!c){return}a.val(a.val()+" "+c).focus();d.modal_window("hide");RMPlus.Usability.hide_history_link(a[0])});$(document.body).on("click","a.us-autosave-delete",function(d){d.stopPropagation();var c=$(this);var f=c.parents("div.modal_window:first");var a=c.parents("tr:first");if(a.length==0){return false}var b=f.data("modal_window").$element.data("elem");if(!b){return false}RMPlus.Usability.delete_field_data(b[0],a.attr("data-id"));a.remove();if(f.find("table tr").length==0){f.modal_window("hide");RMPlus.Usability.hide_history_link(b[0])}return false})}});